@page "/registerExpense"

@using SharedModels.Models
@using SharedModels.Models.RequestModels;
@using SharpExpenses.Services.Contracts;
@using System.ComponentModel.DataAnnotations;

<PageTitle>Registrar gasto</PageTitle>

<div id="header"></div>
<div class="container">
    <h1>Informacion del gasto</h1>

    <EditForm Model="@newExpense" OnValidSubmit="@HandleValidSubmit" class="shadow p-3 mb-5 rounded">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label for="Type">Tipo de gasto</label>
        <InputSelect id="Type" @bind-Value="newExpense.Type" class="form-control">
            <option value="Personal">Personal</option>
            <option value="Business">Trabajo</option>
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="Importance">Necesidad</label>
        <InputSelect id="Importance" @bind-Value="newExpense.Importance" class="form-control">
            <option value="Essential">Esensial</option>
            <option value="NonEssential">No esensial</option>
            <option value="Luxury">Lujo</option>
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="Category">Categoria</label>
        <InputSelect id="Category" @bind-Value="newExpense.CategoryId" class="form-control">
            <option value=0>Abarrotes</option>
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="AmountSpent">Cantidad gastada</label>
        <InputNumber id="AmountSpent" min="0.1" step="0.1" @bind-Value="newExpense.AmountSpent" class="form-control" />
    </div>

    <div class="form-group">
        <label for="Date">Fecha</label>
        <InputDate id="Date" @bind-Value="newExpense.Date" class="form-control" />

        <label for="Time">Hora</label>
        <InputText id="Time" @bind-Value="Time" @onchange="UpdateTime" class="form-control" />
    </div>

    <div class="form-group">
            <label for="Description">Descripcion</label>
            <InputTextArea id="Description" @bind-Value="newExpense.Description" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
</EditForm>
</div>

@code {
    [Required]
    public string Time = DateTime.Now.ToString("HH:mm");
    private ExpenseRequest newExpense = new ExpenseRequest()
    {
            CategoryId = 0,
            AmountSpent = 0.1M,
            Date = DateTime.Now
    };

    [Inject]
    public IExpensesService ExpensesService { get; set; } = null!;


    private void UpdateTime(ChangeEventArgs e)
    {
        Console.WriteLine($"# e.value: {e.Value}");
        if (TimeSpan.TryParse(e.Value!.ToString(), out TimeSpan timeSpan))
        {
            Console.WriteLine($"# timeSpan: {timeSpan}");
            newExpense.Date = newExpense.Date.Date + timeSpan;
            Console.WriteLine($"# newExpanse.Date: {newExpense.Date}");
        }
        Console.WriteLine("# Try parse was not succesful");

    }

    private void HandleValidSubmit()
    {
        this.ExpensesService.Create(newExpense);
    }
}

